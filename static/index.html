<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Debate App</title>
    <!-- Vue.jsを読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; background-color: #f4f4f9; margin: 0; padding: 20px; }
        #app { width: 100%; max-width: 600px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 90vh; }
        .header { padding: 15px; background-color: #42b983; color: white; border-top-left-radius: 8px; border-top-right-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; }
        .reset-button { background-color: #e53935; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .reset-button:hover { background-color: #c62828; }
        .chat-window { flex-grow: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #eee; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .message .content { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .message.user { align-items: flex-end; }
        .message.user .content { background-color: #42b983; color: white; }
        .message.assistant { align-items: flex-start; }
        .message.assistant .content { background-color: #e9e9eb; color: #333; }
        .input-area { display: flex; padding: 15px; border-top: 1px solid #ddd; }
        textarea { flex-grow: 1; border: 1px solid #ccc; border-radius: 5px; padding: 10px; font-size: 16px; resize: none; }
        button { background-color: #42b983; color: white; border: none; padding: 0 20px; margin-left: 10px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:disabled { background-color: #a5d6b8; cursor: not-allowed; }
        .loading-indicator { text-align: center; color: #888; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <h2>AIディベート</h2>
        <button @click="resetDebate" class="reset-button">リセット</button>
    </div>

    <div class="chat-window" ref="chatWindow">
        <div v-for="(msg, index) in conversationHistory" :key="index" :class="['message', msg.role]">
            <div v-if="msg.role !== 'system'" class="content">
                {{ msg.content }}
            </div>
        </div>
        <div v-if="isLoading" class="loading-indicator">
            AIが考えています...
        </div>
    </div>

    <form @submit.prevent="sendMessage" class="input-area">
        <textarea v-model="userInput" placeholder="AIへの意見を入力してください..." @keydown.enter.prevent="sendMessage" :disabled="isLoading"></textarea>
        <button type="submit" :disabled="isLoading || !userInput.trim()">送信</button>
    </form>
</div>

<script>
new Vue({
    el: '#app',
    data: {
        userInput: '',
        conversationHistory: [],
        isLoading: false
    },
    methods: {
        resetDebate() {
            if (confirm("会話履歴を本当にリセットしますか？")) {
                this.conversationHistory = [];
                this.isLoading = false;
            }
        },
        async sendMessage() {
            if (!this.userInput.trim() || this.isLoading) {
                return;
            }

            this.isLoading = true;

            if (this.conversationHistory.length === 0) {
                // ★変更点：前置きをより強力に禁止する指示に変更
                const systemPrompt = "あなたは、ユーザーの意見に即座に反論するAIです。いかなる場合でも、挨拶、相槌、前置き（「しかし、」「一方で、」など）を一切含めず、文章の最初から反論の核心部分だけを記述してください。あなたの役割は、ユーザーの主張に対する直接的な反論のみです。反論は250文字程度にまとめてください。";
                this.conversationHistory.push({ role: 'system', content: systemPrompt });
            }

            const userMessage = this.userInput;
            this.conversationHistory.push({ role: 'user', content: userMessage });
            this.userInput = '';
            this.scrollToBottom();

            try {
                const response = await fetch('/send_api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: this.conversationHistory 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'サーバーでエラーが発生しました。');
                }

                const data = await response.json();
                this.conversationHistory.push({ role: 'assistant', content: data.processed_text });

            } catch (error) {
                console.error('Error:', error);
                this.conversationHistory.push({ role: 'assistant', content: `エラーが発生しました: ${error.message}` });
            } finally {
                this.isLoading = false;
                this.scrollToBottom();
            }
        },
        scrollToBottom() {
            this.$nextTick(() => {
                const chatWindow = this.$refs.chatWindow;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });
        }
    }
});
</script>

</body>
</html>
